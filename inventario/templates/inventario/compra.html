{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static '/css/styles.css' %}">
    <title>Pedido de Compra</title>
    <script>
        let totalPedido = 0;

        function agregarProducto() {
            const productoSelect = document.getElementById("producto");
            const productoId = productoSelect.value;
            const productoNombre = productoSelect.options[productoSelect.selectedIndex].text;
            const precio = parseFloat(productoSelect.options[productoSelect.selectedIndex].dataset.precio);
            const cantidad = parseInt(document.getElementById("cantidad").value);
            const fechaExpiracion = document.getElementById("fecha_expiracion").value;

            if (!productoId || isNaN(cantidad) || cantidad <= 0 || !fechaExpiracion) {
                alert("Por favor, selecciona un producto, ingresa una cantidad válida y una fecha de expiración.");
                return;
            }

            const table = document.getElementById("pedidoTable").getElementsByTagName("tbody")[0];
            let productoYaAgregado = false;

            // Busca si el producto con la misma fecha de expiración ya está en la tabla
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                const nombreProductoEnFila = row.cells[0].innerText;
                const fechaExpiracionEnFila = row.cells[1].innerText;

                if (nombreProductoEnFila === productoNombre && fechaExpiracionEnFila === fechaExpiracion) {
                    // Si el producto con la misma fecha de expiración ya existe, actualiza la cantidad y el total
                    const cantidadActual = parseInt(row.cells[2].innerText);
                    const nuevaCantidad = cantidadActual + cantidad;
                    const nuevoTotalProducto = nuevaCantidad * precio;

                    row.cells[2].innerText = nuevaCantidad;  // Actualiza cantidad
                    row.cells[4].innerText = nuevoTotalProducto.toFixed(2);  // Actualiza total

                    // Actualiza el total del pedido
                    totalPedido += cantidad * precio;
                    document.getElementById("total").innerText = totalPedido.toFixed(2);

                    productoYaAgregado = true;
                    break;
                }
            }

            // Si el producto con una fecha de expiración diferente no está en la tabla, agrega una nueva fila
            if (!productoYaAgregado) {
                const totalProducto = precio * cantidad;
                totalPedido += totalProducto;

                const row = table.insertRow();
                row.innerHTML = `
                    <td>${productoNombre}</td>
                    <td>${fechaExpiracion}</td>
                    <td>${cantidad}</td>
                    <td>${precio.toFixed(2)}</td>
                    <td>${totalProducto.toFixed(2)}</td>
                `;

                document.getElementById("total").innerText = totalPedido.toFixed(2);
            }
        }

        function completarPedido() {
            const proveedor = document.getElementById("proveedor").value;
            const empleado = document.getElementById("empleado").value;  // Obtener el empleado seleccionado
            const total = parseFloat(document.getElementById("total").innerText);
            const table = document.getElementById("pedidoTable").getElementsByTagName("tbody")[0];
            const productos = [];

            // Recolectar todos los productos de la tabla de previsualización
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                const productoNombre = row.cells[0].innerText;
                const fechaExpiracion = row.cells[1].innerText;
                const cantidad = parseInt(row.cells[2].innerText);
                const precio = parseFloat(row.cells[3].innerText);

                productos.push({
                    'nombre': productoNombre,
                    'fecha_expiracion': fechaExpiracion,
                    'cantidad': cantidad,
                    'precio': precio
                });
            }

            if (!proveedor || !empleado) {  // Asegura que el proveedor y el empleado estén seleccionados
                alert("Por favor, selecciona un proveedor y un empleado.");
                return;
            }

            // Realizar la solicitud AJAX para completar la compra
            fetch('{% url "completar_compra" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'proveedor': proveedor,
                    'empleado': empleado,  // Incluir el empleado en los datos enviados
                    'productos': productos,
                    'total': total
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Compra completada y inventario actualizado');
                    location.reload();
                } else {
                    alert(data.error || 'Ocurrió un error');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
</head>
<body>
    <div class="container mt-5">
        <h2>Pedido de Compra</h2>
        <table id="pedidoTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha de Expiración</th>
                    <th>Cantidad</th>
                    <th>Precio</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas de productos se agregarán aquí -->
            </tbody>
        </table>

        <div class="form-group">
            <label for="producto">Seleccionar producto:</label>
            <select id="producto" class="form-control">
                <option value="">(Buscar por lista o por nombre)</option>
                {% for producto in productos %}
                <option value="{{ producto.id_producto }}" data-precio="{{ producto.precio_compra }}">
                    {{ producto.nombre_producto }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="cantidad">Ingresar cantidad:</label>
            <input type="number" id="cantidad" class="form-control" placeholder="(No se puede ingresar más de las existencias)">
        </div>

        <div class="form-group">
            <label for="fecha_expiracion">Fecha de Expiración:</label>
            <input type="date" id="fecha_expiracion" class="form-control">
        </div>

        <button type="button" class="btn btn-warning" onclick="agregarProducto()">Agregar Producto</button>

        <hr>

        <div class="form-group">
            <label for="proveedor">Seleccionar Proveedor:</label>
            <select id="proveedor" class="form-control">
                <option value="">Seleccionar Proveedor</option>
                {% for proveedor in proveedores %}
                <option value="{{ proveedor.nit_proveedor }}">{{ proveedor.nombre_proveedor }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="empleado">Seleccionar Empleado:</label>
            <select id="empleado" class="form-control">
                <option value="">Seleccionar Empleado</option>
                {% for empleado in empleados %}
                <option value="{{ empleado.id_usuario }}">{{ empleado.nombre_usuario }}</option>
                {% endfor %}
            </select>
        </div>

        <h3>Total: <span id="total">0.00</span></h3>

        <button type="button" class="btn btn-warning" onclick="completarPedido()">Completar Pedido</button>
        <button type="button" class="btn btn-warning" onclick="location.href='{% url 'crear_proveedor' %}'">Agregar Proveedor</button>
    </div>
</body>
</html>
